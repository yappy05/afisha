<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê—Ñ–∏—à–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 20px; color: #333; }
        .btn {
            padding: 15px 30px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            width: 100%;
        }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary {
            background: #757575;
        }
        .loading { text-align: center; padding: 20px; }
        .error { background: #ffebee; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .event {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .event h3 { color: #333; margin-bottom: 10px; }
        .event .meta { color: #666; font-size: 14px; margin: 5px 0; }
        .filters {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .filter-group {
            margin-bottom: 15px;
        }
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .category-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .category-btn {
            padding: 8px 15px;
            background: #e0e0e0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .category-btn.active {
            background: #2196F3;
            color: white;
        }
        .date-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
        }
        .apply-filters {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üé≠ –ê—Ñ–∏—à–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h1>

    <button class="btn" onclick="getLocation()">
        üìç –ü–æ–∫–∞–∑–∞—Ç—å –∞—Ñ–∏—à—É –º–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞
    </button>
    <div style="margin: 10px 0;"></div>
    <button class="btn btn-secondary" onclick="showCitySelection()">
        üèôÔ∏è –í—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥
    </button>

    <div class="filters" id="filters" style="display: none;">
        <div class="filter-group">
            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:</label>
            <div class="category-buttons">
                <button class="category-btn active" data-category="all">–í—Å–µ</button>
                <button class="category-btn" data-category="sport">–°–ø–æ—Ä—Ç</button>
                <button class="category-btn" data-category="koncerty">–ö–æ–Ω—Ü–µ—Ä—Ç—ã</button>
                <button class="category-btn" data-category="teatry">–¢–µ–∞—Ç—Ä—ã</button>
            </div>
        </div>
        <div class="filter-group">
            <label>–î–∞—Ç–∞:</label>
            <input type="date" id="selected-date" class="date-input">
        </div>
        <button class="apply-filters" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
    </div>

    <div id="loading" class="loading" style="display: none;">
        –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è...
    </div>

    <div id="results"></div>
</div>

<script>
    let currentCity = '';
    let currentCategory = 'all';
    let currentDate = '';

    function showCitySelection() {
        const results = document.getElementById('results');
        const filters = document.getElementById('filters');

        results.innerHTML = `
        <div style="text-align: center; margin: 20px 0;">
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥:</h3>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn" onclick="selectCity('–ú–æ—Å–∫–≤–∞')" style="flex: 1;">
                    –ú–æ—Å–∫–≤–∞
                </button>
                <button class="btn" onclick="selectCity('–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥')" style="flex: 1;">
                    –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥
                </button>
            </div>
        </div>
    `;

        filters.style.display = 'none';
    }

    function selectCity(city) {
        currentCity = city;
        const filters = document.getElementById('filters');
        filters.style.display = 'block';

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('selected-date').value = today;
        currentDate = today;

        resetFilters();
        loadAfishaWithFilters();
    }

    function resetFilters() {
        currentCategory = 'all';

        // –°–±—Ä–æ—Å UI –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector('.category-btn[data-category="all"]').classList.add('active');
    }

    function initCategoryButtons() {
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentCategory = this.getAttribute('data-category');
                // –ü—Ä–∏ —Å–º–µ–Ω–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                loadAfishaWithFilters();
            });
        });
    }

    function applyFilters() {
        currentDate = document.getElementById('selected-date').value;
        loadAfishaWithFilters();
    }

    function loadAfishaWithFilters() {
        if (!currentCity) {
            alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥');
            return;
        }
        loadAfisha(currentCity, currentCategory, currentDate);
    }

    async function getLocation() {
        const btn = document.querySelector('.btn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const filters = document.getElementById('filters');

        btn.disabled = true;
        loading.style.display = 'block';
        results.innerHTML = '';
        filters.style.display = 'none';

        try {
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    timeout: 10000
                });
            });
            const city = await defineCity(position.coords);
            currentCity = city;
            filters.style.display = 'block';

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('selected-date').value = today;
            currentDate = today;

            resetFilters();
            loadAfishaWithFilters();

        } catch (error) {
            results.innerHTML = `
                    <div class="error">
                        –û—à–∏–±–∫–∞: ${error.message}
                        <br><br>
                        <button class="btn" onclick="selectCity('–ú–æ—Å–∫–≤–∞')">
                            –ü–æ–∫–∞–∑–∞—Ç—å –∞—Ñ–∏—à—É –ú–æ—Å–∫–≤—ã
                        </button>
                        <div style="margin: 10px 0;"></div>
                        <button class="btn" onclick="selectCity('–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥')">
                            –ü–æ–∫–∞–∑–∞—Ç—å –∞—Ñ–∏—à—É –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞
                        </button>
                    </div>
                `;
        } finally {
            btn.disabled = false;
            loading.style.display = 'none';
        }
    }

    async function defineCity(coords) {
        const moscow = { lat: 55.7558, lng: 37.6173, radius: 1 };
        const spb = { lat: 59.9343, lng: 30.3351, radius: 1 };

        const distanceToMoscow = getDistance(coords.latitude, coords.longitude, moscow.lat, moscow.lng);
        const distanceToSpb = getDistance(coords.latitude, coords.longitude, spb.lat, spb.lng);

        if (distanceToMoscow <= moscow.radius) return '–º–æ—Å–∫–≤–∞';
        if (distanceToSpb <= spb.radius) return '—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥';

        throw new Error('–û–ø—Ä–µ–¥–µ–ª–µ–Ω —Ä–µ–≥–∏–æ–Ω –≤–Ω–µ –ú–æ—Å–∫–≤—ã –∏–ª–∏ –ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞');
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        return Math.sqrt(Math.pow(lat1 - lat2, 2) + Math.pow(lon1 - lon2, 2));
    }

    function formatDateForAPI(dateString) {
        if (!dateString) return '';

        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');

        const startOfDay = `${year}-${month}-${day}T00:00:00+03:00`;
        const endOfDay = `${year}-${month}-${day}T23:59:59+03:00`;

        return `${startOfDay},${endOfDay}`;
    }

    function getCitySlug(city) {
        const citySlugs = {
            '–ú–æ—Å–∫–≤–∞': 'moscow',
            '–º–æ—Å–∫–≤–∞': 'moscow',
            '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥': 'saint-petersburg',
            '—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥': 'saint-petersburg'
        };
        return citySlugs[city] || city.toLowerCase();
    }

    function getCategorySlug(category) {
        const categorySlugs = {
            'all': 'events', // –í—Å–µ -> events
            'sport': 'sport',
            'koncerty': 'koncerty',
            'teatry': 'teatry'
        };
        return categorySlugs[category] || 'events';
    }

    async function loadAfisha(city, category = 'all', date = '') {
        const results = document.getElementById('results');
        const loading = document.getElementById('loading');

        loading.style.display = 'block';
        results.innerHTML = '';

        try {
            const citySlug = getCitySlug(city);
            const categorySlug = getCategorySlug(category);

            // –§–æ—Ä–º–∏—Ä—É–µ–º URL: /–≥–æ—Ä–æ–¥/–∫–∞—Ç–µ–≥–æ—Ä–∏—è?date=...
            let url = `http://localhost:3000/api/parser/${citySlug}/`;
            if (categorySlug === 'events') {
                url+= `events`
            } else {
                url += `categories/${categorySlug}`
            }

            // –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é
            let selectedDate = date;
            if (!selectedDate) {
                selectedDate = new Date().toISOString().split('T')[0];
            }

            const formattedDate = formatDateForAPI(selectedDate);
            if (formattedDate) {
                const encodedDate = encodeURIComponent(formattedDate)
                    .replace(/:/g, '%3A')
                    .replace(/\+/g, '%2B');
                url += `?date=${encodedDate}`;
            }

            console.log('Request URL:', url);

            const response = await fetch(url);
            const data = await response.json();

            if (!response.ok) throw new Error(data.error);

            if (data.events.length === 0) {
                results.innerHTML = '<p>–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                return;
            }

            results.innerHTML = `
                    <h2>üé™ –ê—Ñ–∏—à–∞: ${data.city}</h2>
                    ${selectedDate ? `<p style="margin-bottom: 15px; color: #666;">–ù–∞ –¥–∞—Ç—É: ${new Date(selectedDate).toLocaleDateString('ru-RU')}</p>` : ''}
                    ${category && category !== 'all' ? `<p style="margin-bottom: 15px; color: #666;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${getCategoryName(category)}</p>` : ''}
                    ${data.events.map(event => `
                        <div class="event">
                            <h3>${event.title}</h3>
                            <div class="meta">üìÖ ${event.date}</div>
                            <div class="meta">üìç ${event.place}</div>
                            <div class="meta">üè∑Ô∏è ${event.category || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                            <p>${event.description}</p>
                        </div>
                    `).join('')}
                `;

        } catch (error) {
            results.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
        } finally {
            loading.style.display = 'none';
        }
    }

    function getCategoryName(categorySlug) {
        const categoryNames = {
            'all': '–í—Å–µ',
            'sport': '–°–ø–æ—Ä—Ç',
            'koncerty': '–ö–æ–Ω—Ü–µ—Ä—Ç—ã',
            'teatry': '–¢–µ–∞—Ç—Ä—ã'
        };
        return categoryNames[categorySlug] || categorySlug;
    }

    document.addEventListener('DOMContentLoaded', function() {
        initCategoryButtons();
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('selected-date').min = today;
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        document.getElementById('selected-date').value = today;
        currentDate = today;
    });
</script>
</body>
</html>