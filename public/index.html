<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê—Ñ–∏—à–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 20px; color: #333; }
        .btn {
            padding: 15px 30px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            width: 100%;
        }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .loading { text-align: center; padding: 20px; }
        .error { background: #ffebee; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .event {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .event h3 { color: #333; margin-bottom: 10px; }
        .event .meta { color: #666; font-size: 14px; margin: 5px 0; }
    </style>
</head>
<body>
<div class="container">
    <h1>üé≠ –ê—Ñ–∏—à–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h1>

    <button class="btn" onclick="getLocation()">
        üìç –ü–æ–∫–∞–∑–∞—Ç—å –∞—Ñ–∏—à—É –º–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞
    </button>
    <div style="margin: 10px 0;"></div>
    <button class="btn btn-secondary" onclick="showCitySelection()">
        üèôÔ∏è –í—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥
    </button>


    <div id="loading" class="loading" style="display: none;">
        –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è...
    </div>

    <div id="results"></div>
</div>

<script>

    function showCitySelection() {
        const results = document.getElementById('results');

        results.innerHTML = `
        <div style="text-align: center; margin: 20px 0;">
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥:</h3>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn" onclick="loadAfisha('–ú–æ—Å–∫–≤–∞')" style="flex: 1;">
                    –ú–æ—Å–∫–≤–∞
                </button>
                <button class="btn" onclick="loadAfisha('–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥')" style="flex: 1;">
                    –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥
                </button>
            </div>
        </div>
    `;
    }

    async function getLocation() {
        const btn = document.querySelector('.btn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');

        btn.disabled = true;
        loading.style.display = 'block';
        results.innerHTML = '';

        try {
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    timeout: 10000
                });
            });
            const city = await defineCity(position.coords);
            console.log('coordinates are:', position.coords)
            console.log('city is:', city)

            await loadAfisha(city);

        } catch (error) {
            results.innerHTML = `
                    <div class="error">
                        –û—à–∏–±–∫–∞: ${error.message}
                        <br><br>
                        <button class="btn" onclick="loadAfisha('–ú–æ—Å–∫–≤–∞')">
                            –ü–æ–∫–∞–∑–∞—Ç—å –∞—Ñ–∏—à—É –ú–æ—Å–∫–≤—ã
                        </button>
                        <div style="margin: 10px 0;"></div>
                        <button class="btn" onclick="loadAfisha('–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥')">
                            –ü–æ–∫–∞–∑–∞—Ç—å –∞—Ñ–∏—à—É –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞
                    </div>
                `;
        } finally {
            btn.disabled = false;
            loading.style.display = 'none';
        }
    }


    async function defineCity(coords) {
        const moscow = { lat: 55.7558, lng: 37.6173, radius: 1 };
        const spb = { lat: 59.9343, lng: 30.3351, radius: 1 };

        const distanceToMoscow = getDistance(coords.latitude, coords.longitude, moscow.lat, moscow.lng);
        const distanceToSpb = getDistance(coords.latitude, coords.longitude, spb.lat, spb.lng);

        if (distanceToMoscow <= moscow.radius) return '–º–æ—Å–∫–≤–∞';
        if (distanceToSpb <= spb.radius) return '—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥';

        throw new Error('–û–ø—Ä–µ–¥–µ–ª–µ–Ω —Ä–µ–≥–∏–æ–Ω –≤–Ω–µ –ú–æ—Å–∫–≤—ã –∏–ª–∏ –ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞');
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        return Math.sqrt(Math.pow(lat1 - lat2, 2) + Math.pow(lon1 - lon2, 2));
    }

    async function loadAfisha(city) {
        const results = document.getElementById('results');

        try {
            const response = await fetch(`/api/afisha?city=${encodeURIComponent(city)}`);
            const data = await response.json();

            if (!response.ok) throw new Error(data.error);

            if (data.events.length === 0) {
                results.innerHTML = '<p>–ù–∞ —Å–µ–≥–æ–¥–Ω—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                return;
            }

            results.innerHTML = `
                    <h2>üé™ –ê—Ñ–∏—à–∞: ${data.city}</h2>
                    ${data.events.map(event => `
                        <div class="event">
                            <h3>${event.title}</h3>
                            <div class="meta">üìÖ ${event.date}</div>
                            <div class="meta">üìç ${event.place}</div>
                            <p>${event.description}</p>
                        </div>
                    `).join('')}
                `;

        } catch (error) {
            results.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
        }
    }
</script>
</body>
</html>