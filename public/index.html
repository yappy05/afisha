<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê—Ñ–∏—à–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 20px; color: #333; }
        .btn {
            padding: 15px 30px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            width: 100%;
        }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary {
            background: #757575;
        }
        .loading { text-align: center; padding: 20px; }
        .error { background: #ffebee; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .event {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .event h3 { color: #333; margin-bottom: 10px; }
        .event .meta { color: #666; font-size: 14px; margin: 5px 0; }
        .filters {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .filter-group {
            margin-bottom: 15px;
        }
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .category-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .category-btn {
            padding: 8px 15px;
            background: #e0e0e0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .category-btn.active {
            background: #2196F3;
            color: white;
        }
        .date-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
        }
        .apply-filters {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            gap: 10px;
        }
        .page-btn {
            padding: 8px 15px;
            background: #e0e0e0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .page-btn.active {
            background: #2196F3;
            color: white;
        }
        .page-btn:disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }
        .page-info {
            margin: 0 15px;
            color: #666;
        }
        .events-count {
            text-align: center;
            margin: 10px 0;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üé≠ –ê—Ñ–∏—à–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h1>

    <button class="btn" onclick="getLocation()">
        üìç –ü–æ–∫–∞–∑–∞—Ç—å –∞—Ñ–∏—à—É –º–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞
    </button>
    <div style="margin: 10px 0;"></div>
    <button class="btn btn-secondary" onclick="showCitySelection()">
        üèôÔ∏è –í—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥
    </button>

    <div class="filters" id="filters" style="display: none;">
        <div class="filter-group">
            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:</label>
            <div class="category-buttons">
                <button class="category-btn active" data-category="all">–í—Å–µ</button>
                <button class="category-btn" data-category="sport">–°–ø–æ—Ä—Ç</button>
                <button class="category-btn" data-category="koncerty">–ö–æ–Ω—Ü–µ—Ä—Ç—ã</button>
                <button class="category-btn" data-category="teatry">–¢–µ–∞—Ç—Ä—ã</button>
            </div>
        </div>
        <div class="filter-group">
            <label>–î–∞—Ç–∞:</label>
            <input type="date" id="selected-date" class="date-input">
        </div>
        <button class="apply-filters" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
    </div>

    <div id="loading" class="loading" style="display: none;">
        –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è...
    </div>

    <div id="results"></div>
</div>

<script>
    let currentCity = '';
    let currentCategory = 'all';
    let currentDate = '';
    let currentEvents = [];
    let currentPage = 1;
    const eventsPerPage = 10; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ

    function showCitySelection() {
        const results = document.getElementById('results');
        const filters = document.getElementById('filters');

        results.innerHTML = `
            <div style="text-align: center; margin: 20px 0;">
                <h3>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥:</h3>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn" onclick="selectCity('–ú–æ—Å–∫–≤–∞')" style="flex: 1;">
                        –ú–æ—Å–∫–≤–∞
                    </button>
                    <button class="btn" onclick="selectCity('–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥')" style="flex: 1;">
                        –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥
                    </button>
                </div>
            </div>
        `;

        filters.style.display = 'none';
    }

    function selectCity(city) {
        currentCity = city;
        currentPage = 1; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        const filters = document.getElementById('filters');
        filters.style.display = 'block';

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('selected-date').value = today;
        currentDate = today;

        resetFilters();
        loadAfishaWithFilters();
    }

    function resetFilters() {
        currentCategory = 'all';
        currentPage = 1; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É

        // –°–±—Ä–æ—Å UI –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector('.category-btn[data-category="all"]').classList.add('active');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentCategory = this.getAttribute('data-category');
                currentPage = 1; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                loadAfishaWithFilters();
            });
        });
    });

    function applyFilters() {
        currentDate = document.getElementById('selected-date').value;
        currentPage = 1; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        loadAfishaWithFilters();
    }

    function loadAfishaWithFilters() {
        if (!currentCity) {
            alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥');
            return;
        }
        loadAfisha(currentCity, currentCategory, currentDate);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
    function displayEvents(events, page = 1) {
        const results = document.getElementById('results');
        const totalEvents = events.length;
        const totalPages = Math.ceil(totalEvents / eventsPerPage);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if (page < 1) page = 1;
        if (page > totalPages) page = totalPages;

        currentPage = page;

        // –í—ã—á–∏—Å–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const startIndex = (page - 1) * eventsPerPage;
        const endIndex = Math.min(startIndex + eventsPerPage, totalEvents);
        const pageEvents = events.slice(startIndex, endIndex);

        // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è —Å–æ–±—ã—Ç–∏–π
        let eventsHTML = '';

        if (pageEvents.length === 0) {
            eventsHTML = '<p>–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
        } else {
            eventsHTML = pageEvents.map(event => `
                <div class="event">
                    <h3>${event.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h3>
                    <div class="meta">üìÖ ${event.time || '–î–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                    <div class="meta">üìç ${event.place || '–ú–µ—Å—Ç–æ –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                    <div class="meta">üè∑Ô∏è ${event.category || '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                    ${event.description ? `<p>${event.description}</p>` : ''}
                </div>
            `).join('');
        }

        // –°–æ–∑–¥–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
        let paginationHTML = '';
        if (totalPages > 1) {
            paginationHTML = `
                <div class="pagination">
                    <button class="page-btn" onclick="displayEvents(currentEvents, 1)" ${page === 1 ? 'disabled' : ''}>
                        ‚ùÆ‚ùÆ
                    </button>
                    <button class="page-btn" onclick="displayEvents(currentEvents, ${page - 1})" ${page === 1 ? 'disabled' : ''}>
                        ‚ùÆ
                    </button>

                    <span class="page-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${page} –∏–∑ ${totalPages}</span>

                    <button class="page-btn" onclick="displayEvents(currentEvents, ${page + 1})" ${page === totalPages ? 'disabled' : ''}>
                        ‚ùØ
                    </button>
                    <button class="page-btn" onclick="displayEvents(currentEvents, ${totalPages})" ${page === totalPages ? 'disabled' : ''}>
                        ‚ùØ‚ùØ
                    </button>
                </div>
            `;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        results.innerHTML = `
            <h2>üé™ –ê—Ñ–∏—à–∞: ${currentCity}</h2>
            ${currentDate ? `<p style="margin-bottom: 15px; color: #666;">–ù–∞ –¥–∞—Ç—É: ${new Date(currentDate).toLocaleDateString('ru-RU')}</p>` : ''}
            ${currentCategory && currentCategory !== 'all' ? `<p style="margin-bottom: 15px; color: #666;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${getCategoryName(currentCategory)}</p>` : ''}
            <div class="events-count">–ù–∞–π–¥–µ–Ω–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π: ${totalEvents}</div>
            ${paginationHTML}
            ${eventsHTML}
            ${paginationHTML}
        `;
    }

    function getCategoryName(category) {
        const categoryNames = {
            'all': '–í—Å–µ',
            'sport': '–°–ø–æ—Ä—Ç',
            'koncerty': '–ö–æ–Ω—Ü–µ—Ä—Ç—ã',
            'teatry': '–¢–µ–∞—Ç—Ä—ã'
        };
        return categoryNames[category] || category;
    }

    async function getLocation() {
        const btn = document.querySelector('.btn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const filters = document.getElementById('filters');

        btn.disabled = true;
        loading.style.display = 'block';
        results.innerHTML = '';
        filters.style.display = 'none';

        try {
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    timeout: 10000
                });
            });
            const city = await defineCity(position.coords);
            currentCity = city;
            currentPage = 1; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            filters.style.display = 'block';

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('selected-date').value = today;
            currentDate = today;

            resetFilters();
            loadAfishaWithFilters();

        } catch (error) {
            results.innerHTML = `
                <div class="error">
                    –û—à–∏–±–∫–∞: ${error.message}
                    <br><br>
                    <button class="btn" onclick="selectCity('–ú–æ—Å–∫–≤–∞')">
                        –ü–æ–∫–∞–∑–∞—Ç—å –∞—Ñ–∏—à—É –ú–æ—Å–∫–≤—ã
                    </button>
                    <div style="margin: 10px 0;"></div>
                    <button class="btn" onclick="selectCity('–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥')">
                        –ü–æ–∫–∞–∑–∞—Ç—å –∞—Ñ–∏—à—É –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞
                    </button>
                </div>
            `;
        } finally {
            btn.disabled = false;
            loading.style.display = 'none';
        }
    }

    async function defineCity(coords) {
        const moscow = { lat: 55.7558, lng: 37.6173, radius: 1 };
        const spb = { lat: 59.9343, lng: 30.3351, radius: 1 };

        const distanceToMoscow = getDistance(coords.latitude, coords.longitude, moscow.lat, moscow.lng);
        const distanceToSpb = getDistance(coords.latitude, coords.longitude, spb.lat, spb.lng);

        if (distanceToMoscow <= moscow.radius) return '–ú–æ—Å–∫–≤–∞';
        if (distanceToSpb <= spb.radius) return '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥';

        throw new Error('–û–ø—Ä–µ–¥–µ–ª–µ–Ω —Ä–µ–≥–∏–æ–Ω –≤–Ω–µ –ú–æ—Å–∫–≤—ã –∏–ª–∏ –ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞');
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        return Math.sqrt(Math.pow(lat1 - lat2, 2) + Math.pow(lon1 - lon2, 2));
    }

    function formatDateForAPI(dateString) {
        if (!dateString) return '';

        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');

        const startOfDay = `${year}-${month}-${day}T00:00:00+03:00`;
        const endOfDay = `${year}-${month}-${day}T23:59:59+03:00`;

        return `${startOfDay},${endOfDay}`;
    }

    function getCitySlug(city) {
        const citySlugs = {
            '–ú–æ—Å–∫–≤–∞': 'moscow',
            '–º–æ—Å–∫–≤–∞': 'moscow',
            '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥': 'saint-petersburg',
            '—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥': 'saint-petersburg',
            '—Å–ø–±': 'saint-petersburg',
            '–ø–∏—Ç–µ—Ä': 'saint-petersburg'
        };
        return citySlugs[city] || city.toLowerCase();
    }

    function getCategorySlug(category) {
        const categorySlugs = {
            'all': 'events',
            'sport': 'sport',
            'koncerty': 'koncerty',
            'teatry': 'teatry'
        };
        return categorySlugs[category] || 'events';
    }

    async function loadAfisha(city, category = 'all', date = '') {
        const results = document.getElementById('results');
        const loading = document.getElementById('loading');

        loading.style.display = 'block';
        results.innerHTML = '';

        try {
            const citySlug = getCitySlug(city);
            const categorySlug = getCategorySlug(category);

            let url = `http://localhost:3000/api/parser`;

            // –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é
            let selectedDate = date;
            if (!selectedDate) {
                selectedDate = new Date().toISOString().split('T')[0];
            }

            const formattedDate = formatDateForAPI(selectedDate);
            const encoded = encodeURIComponent(formattedDate);

            console.log('Request URL:', url);
            console.log('Request body:', {
                city: citySlug,
                category: categorySlug,
                formattedDate: encoded
            });

            const requestBody = {
                city: citySlug,
                category: categorySlug,
                formattedDate: encoded
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Full response data:', data);

            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –æ—Ç–≤–µ—Ç–∞
            let events = [];

            if (Array.isArray(data)) {
                // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç - –º–∞—Å—Å–∏–≤
                events = data;
            } else if (data.elements && Array.isArray(data.elements)) {
                // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –∏–º–µ–µ—Ç –ø–æ–ª–µ elements —Å –º–∞—Å—Å–∏–≤–æ–º
                events = data.elements;
            } else if (data.events && Array.isArray(data.events)) {
                // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –∏–º–µ–µ—Ç –ø–æ–ª–µ events —Å –º–∞—Å—Å–∏–≤–æ–º
                events = data.events;
            } else if (data.success && Array.isArray(data.data)) {
                // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –∏–º–µ–µ—Ç –ø–æ–ª–µ data —Å –º–∞—Å—Å–∏–≤–æ–º
                events = data.data;
            } else {
                console.warn('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:', data);
            }

            console.log('Extracted events:', events);
            console.log('Number of events:', events.length);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
            currentEvents = events;

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
            displayEvents(currentEvents, currentPage);

        } catch (error) {
            console.error('Error loading afisha:', error);
            results.innerHTML = `
            <div class="error">
                –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}
                <br><br>
                <div style="font-size: 14px;">
                    –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
                    <ul>
                        <li>–ó–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–∞ localhost:3000</li>
                        <li>–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å API endpoint</li>
                        <li>–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –æ—Ç–≤–µ—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞</li>
                    </ul>
                </div>
            </div>
        `;
        } finally {
            loading.style.display = 'none';
        }
    }
</script>
</body>
</html>